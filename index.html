<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase Direct Chat</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; background-color: #f4f4f8; display: flex; flex-direction: column; height: 100vh; }
        .hidden { display: none !important; }

        /* --- Header --- */
        header { background-color: #fff; border-bottom: 1px solid #ddd; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 4px rgba(0,0,0,0.05); flex-shrink: 0;}
        header h1 { margin: 0; font-size: 24px; }
        #signInBtn, #signOutBtn { padding: 10px 15px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; background-color: #4285F4; color: white; }
        
        /* --- Main App Layout --- */
        #app-container { display: flex; flex-grow: 1; overflow: hidden; }
        #sidebar { width: 300px; border-right: 1px solid #ddd; background: #fff; display: flex; flex-direction: column; }
        #chat-window { flex-grow: 1; display: flex; flex-direction: column; background: #e5ddd5; }

        /* --- Sidebar Content --- */
        #my-profile { padding: 20px; text-align: center; border-bottom: 1px solid #ddd; }
        #my-profile p { margin: 5px 0; }
        #my-chat-id { font-weight: bold; background: #eee; padding: 5px 10px; border-radius: 5px; user-select: all; }
        #search-container { padding: 15px; border-bottom: 1px solid #ddd; }
        #search-container input { width: 100%; padding: 10px; border-radius: 20px; border: 1px solid #ccc; box-sizing: border-box; }
        #chat-list { flex-grow: 1; overflow-y: auto; }
        .chat-item { display: flex; align-items: center; padding: 15px; cursor: pointer; border-bottom: 1px solid #f0f0f0; }
        .chat-item:hover, .chat-item.active { background: #f0f0f0; }
        .chat-item img { width: 50px; height: 50px; border-radius: 50%; margin-right: 15px; }

        /* --- Chat Window Content --- */
        #welcome-screen { text-align: center; margin: auto; color: #555; }
        #chat-header { padding: 15px 20px; background: #f0f0f0; border-bottom: 1px solid #ddd; font-weight: bold; }
        #messages { flex-grow: 1; overflow-y: auto; padding: 20px; }
        #messageForm { display: flex; padding: 15px; background: #f0f0f0; }
        #messageInput { flex-grow: 1; border: 1px solid #ccc; border-radius: 18px; padding: 10px 15px; font-size: 16px; }
        #messageForm button { margin-left: 10px; padding: 10px 20px; border: none; background-color: #0084ff; color: white; border-radius: 18px; font-size: 16px; cursor: pointer; }
        
        /* --- Message Bubbles --- */
        .message { display: flex; margin-bottom: 10px; max-width: 70%; }
        .message .text { padding: 10px 15px; border-radius: 18px; }
        .message.sent { margin-left: auto; flex-direction: row-reverse; }
        .message.sent .text { background-color: #dcf8c6; }
        .message.received .text { background-color: #fff; }
    </style>
</head>
<body>

    <header>
        <h1>Direct Chat</h1>
        <div>
            <button id="signInBtn">Sign in with Google</button>
            <button id="signOutBtn" class="hidden">Sign Out</button>
        </div>
    </header>

    <div id="app-container" class="hidden">
        <aside id="sidebar">
            <div id="my-profile">
                <h3>Your Info</h3>
                <p>Your unique chat ID is:</p>
                <p id="my-chat-id">loading...</p>
            </div>
            <div id="search-container">
                <form id="search-form">
                    <input type="search" id="search-input" placeholder="Search by chat ID...">
                </form>
            </div>
            <div id="chat-list"></div>
        </aside>
        
        <main id="chat-window">
            <div id="welcome-screen">
                <h2>Welcome to Direct Chat!</h2>
                <p>Select a conversation or find a user by their ID to start chatting.</p>
            </div>
            <div id="chat-view" class="hidden">
                <div id="chat-header"></div>
                <div id="messages"></div>
                <form id="messageForm">
                    <input type="text" id="messageInput" placeholder="Type a message" autocomplete="off" required>
                    <button type="submit">Send</button>
                </form>
            </div>
        </main>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, addDoc, query, where, orderBy, onSnapshot, serverTimestamp, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAKPs0IJ-Wt7cCIMZnmw61SlMc6Gl48Fi8",
            authDomain: "chatcommunication-bd5d4.firebaseapp.com",
            projectId: "chatcommunication-bd5d4",
            storageBucket: "chatcommunication-bd5d4.appspot.com",
            messagingSenderId: "921211744909",
            appId: "1:921211744909:web:418e5758011c29fe4128c4",
            measurementId: "G-XXJRRW78KQ"
        };

        // --- 1. INITIALIZE ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- GLOBAL STATE ---
        let currentUser = null;
        let currentChatId = null;
        let messageListenerUnsubscribe = null;

        // --- DOM ELEMENTS ---
        const signInBtn = document.getElementById('signInBtn');
        const signOutBtn = document.getElementById('signOutBtn');
        const appContainer = document.getElementById('app-container');
        const myChatIdEl = document.getElementById('my-chat-id');
        const searchForm = document.getElementById('search-form');
        const searchInput = document.getElementById('search-input');
        const chatListEl = document.getElementById('chat-list');
        const welcomeScreen = document.getElementById('welcome-screen');
        const chatView = document.getElementById('chat-view');
        const chatHeaderEl = document.getElementById('chat-header');
        const messagesEl = document.getElementById('messages');
        const messageForm = document.getElementById('messageForm');
        const messageInput = document.getElementById('messageInput');

        // --- AUTHENTICATION ---
        signInBtn.onclick = () => signInWithPopup(auth, new GoogleAuthProvider());
        signOutBtn.onclick = () => signOut(auth);

        onAuthStateChanged(auth, user => {
            if (user) {
                // User is signed in
                currentUser = user;
                signInBtn.classList.add('hidden');
                signOutBtn.classList.remove('hidden');
                appContainer.classList.remove('hidden');
                setupUser(user);
                loadUserChats(user.uid);
            } else {
                // User is signed out
                currentUser = null;
                signInBtn.classList.remove('hidden');
                signOutBtn.classList.add('hidden');
                appContainer.classList.add('hidden');
                chatListEl.innerHTML = '';
            }
        });

        // --- USER SETUP & PROFILE ---
        async function setupUser(user) {
            const userRef = doc(db, 'users', user.uid);
            const userDoc = await getDoc(userRef);

            if (!userDoc.exists()) {
                // New user, create their profile with a unique chat ID
                const username = user.displayName.split(' ')[0].toLowerCase();
                const randomNum = Math.floor(1000 + Math.random() * 9000);
                const chatId = `${username}${randomNum}`;

                await setDoc(userRef, {
                    displayName: user.displayName,
                    photoURL: user.photoURL,
                    email: user.email,
                    chatId: chatId
                });
                myChatIdEl.textContent = chatId;
            } else {
                myChatIdEl.textContent = userDoc.data().chatId;
            }
        }

        // --- SEARCH & START NEW CHAT ---
        searchForm.addEventListener('submit', async e => {
            e.preventDefault();
            const searchTerm = searchInput.value.trim();
            if (searchTerm === '') return;

            const usersRef = collection(db, 'users');
            const q = query(usersRef, where("chatId", "==", searchTerm));
            const querySnapshot = await getDocs(q);

            if (querySnapshot.empty) {
                alert("User not found!");
            } else {
                const foundUser = querySnapshot.docs[0].data();
                const foundUserId = querySnapshot.docs[0].id;

                if (foundUserId === currentUser.uid) {
                    alert("You can't chat with yourself!");
                    return;
                }

                // Create a unique, consistent chat ID for the two users
                const chatId = [currentUser.uid, foundUserId].sort().join('_');
                
                const chatRef = doc(db, 'chats', chatId);
                const chatDoc = await getDoc(chatRef);

                if (!chatDoc.exists()) {
                    // Create a new chat
                    await setDoc(chatRef, {
                        participants: [currentUser.uid, foundUserId],
                        participantDetails: {
                            [currentUser.uid]: { displayName: currentUser.displayName, photoURL: currentUser.photoURL },
                            [foundUserId]: { displayName: foundUser.displayName, photoURL: foundUser.photoURL }
                        },
                        lastMessage: 'Chat started.',
                        updatedAt: serverTimestamp()
                    });
                }
                openChat(chatId);
            }
            searchInput.value = '';
        });

        // --- LOAD EXISTING CHATS IN SIDEBAR ---
        function loadUserChats(uid) {
            const chatsRef = collection(db, 'chats');
            const q = query(chatsRef, where("participants", "array-contains", uid), orderBy("updatedAt", "desc"));
            
            onSnapshot(q, (snapshot) => {
                chatListEl.innerHTML = '';
                snapshot.forEach(doc => {
                    const chat = doc.data();
                    const otherUserId = chat.participants.find(id => id !== uid);
                    const otherUserDetails = chat.participantDetails[otherUserId];

                    const chatItem = document.createElement('div');
                    chatItem.className = 'chat-item';
                    chatItem.dataset.chatId = doc.id;
                    chatItem.innerHTML = `
                        <img src="${otherUserDetails.photoURL}" alt="${otherUserDetails.displayName}">
                        <div>
                            <strong>${otherUserDetails.displayName}</strong>
                            <p>${chat.lastMessage}</p>
                        </div>
                    `;
                    chatItem.onclick = () => openChat(doc.id);
                    chatListEl.appendChild(chatItem);
                });
            });
        }

        // --- OPEN A CHAT ---
        async function openChat(chatId) {
            // Unsubscribe from previous chat's message listener if it exists
            if (messageListenerUnsubscribe) {
                messageListenerUnsubscribe();
            }

            currentChatId = chatId;
            
            // Highlight active chat in the sidebar
            document.querySelectorAll('.chat-item').forEach(el => el.classList.remove('active'));
            document.querySelector(`.chat-item[data-chat-id="${chatId}"]`).classList.add('active');

            // Set up chat window
            const chatRef = doc(db, 'chats', chatId);
            const chatDoc = await getDoc(chatRef);
            const chatData = chatDoc.data();
            const otherUserId = chatData.participants.find(id => id !== currentUser.uid);
            const otherUserDetails = chatData.participantDetails[otherUserId];

            chatHeaderEl.textContent = otherUserDetails.displayName;
            welcomeScreen.classList.add('hidden');
            chatView.classList.remove('hidden');
            messagesEl.innerHTML = ''; // Clear previous messages

            // Listen for new messages in this chat
            const messagesRef = collection(db, `chats/${chatId}/messages`);
            const q = query(messagesRef, orderBy('createdAt'));

            messageListenerUnsubscribe = onSnapshot(q, snapshot => {
                messagesEl.innerHTML = '';
                snapshot.forEach(doc => {
                    const msg = doc.data();
                    const messageDiv = document.createElement('div');
                    messageDiv.className = 'message ' + (msg.senderId === currentUser.uid ? 'sent' : 'received');
                    messageDiv.innerHTML = `<div class="text">${msg.text}</div>`;
                    messagesEl.appendChild(messageDiv);
                });
                // Auto-scroll to bottom
                messagesEl.scrollTop = messagesEl.scrollHeight;
            });
        }
        
        // --- SEND A MESSAGE ---
        messageForm.addEventListener('submit', async e => {
            e.preventDefault();
            const text = messageInput.value.trim();
            if (text === '' || !currentChatId) return;

            const messagesRef = collection(db, `chats/${currentChatId}/messages`);
            await addDoc(messagesRef, {
                text: text,
                senderId: currentUser.uid,
                createdAt: serverTimestamp()
            });

            // Update the last message on the parent chat document for the sidebar
            const chatRef = doc(db, 'chats', currentChatId);
            await updateDoc(chatRef, {
                lastMessage: text,
                updatedAt: serverTimestamp()
            });

            messageInput.value = '';
        });

    </script>
</body>
</html>
